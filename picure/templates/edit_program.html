{% extends 'base.html' %}
{% block title %}Edit Program - PiCure {% endblock %}
{% block head %}
<script>
    var current_prog_id = window.location.href.split("/")[4]
    function delayed_reload(){
        setTimeout(function () {
            window.location.reload()
        }, 100)
    }

    function delete_prog(step_id) {
        req = new XMLHttpRequest()
        req.open("DELETE", "/api/program/"+current_prog_id+"/step/"+step_id, true)
        req.onload = function () {
            if(req.readyState == req.DONE){
                if(req.status == "200"){
                    delayed_reload()
                    console.log("DELETED step with id: "+current_prog_id+" for program: " +prog_id)
                }
                if(req.status == "500"){
                    var box = document.getElementById("alertbox")
                    box.innerText = 'Warning: Can`t delete step. Something is wrong.'
                    new bootstrap.Collapse(box, {
                        show: true
                    })
                }
            }
        }
        req.send()
    }

    function formatTime(timeMS) {
        var ms = timeMS

        var d = Math.round(ms/86400000)
        ms = ms % 86400000

        var h = Math.round(ms/3600000)
        ms = ms%3600000

        var m = Math.round(ms/60000)
        ms = ms%60000

        var s = Math.round(ms/1000)
        ms = Math.round(ms%1000)


        return d + ":" + h + ":" + m + ":" + s + ":" + ms
    }

    function add_tbl_elements_from_json(data) {
        var tbl = document.getElementById('step_tbl').getElementsByTagName('tbody')[0];
        for(i=0; i<data.length; i++){
            var row = tbl.insertRow(i)
            var id_cell = row.insertCell(0)
            var duration_cell = row.insertCell(1)
            var targets_cell = row.insertCell(2)
            var actions_cell = row.insertCell(3)

            id_cell.innerText = i+1
            duration_cell.innerHTML = '<div class="col">'+formatTime(data[i][1])+'</div>'

            for(t=0;t<Object.entries(data[i][2]).length;t++){
                var l_dat = Object.entries(data[i][2])[t]
                targets_cell.innerHTML += '<div class="row">' +
                    '<div class="col-6">'+l_dat[0]+'</div>' +
                    '<div class="col-6">'+l_dat[1]+'</div>' +
                    '</div>'
            }

            actions_cell.innerHTML = '<button type="button" class="btn btn-primary">Edit</button> ' +
                '<button type=button class="btn btn-danger" onclick="delete_prog('+String(i+1)+')">X</button>'
        }
    }

    var steps
    req = new XMLHttpRequest()
    req.open("GET", "/api/program/"+current_prog_id)
    req.onreadystatechange = function () {
            if(req.readyState == req.DONE){
                if(req.status == "200"){
                    steps = JSON.parse(req.responseText)
                    add_tbl_elements_from_json(steps)
                }
            }
        }
    req.send()
</script>
{% endblock %}
{% block content %}
<div class="container">
<div class="row">
    <div id="title-heading" class="col">
    </div>
    <div class="col">
        <button class="btn btn-primary float-end" data-bs-toggle="collapse" data-bs-target="#new_step_form" aria-expanded="false" aria-controls="new_step_form">Add new step...</button>
    </div>
    </div>
    <div class="row mt-4">
        <div id="new_step_form" class="collapse">
            <form id="new-step" method="post">
                <div class="row">
                    <div class="col-4"><label class="form-label" for="program-duration">Program duration and unit</label></div>
                    <div class="col-4"><input name="value" type="text" class="form-control"></div>
                    <div class="col-4"><input name="unit" type="text" class="form-control"></div>
                </div>
                <div class="row">
                    <div class="col-4"></div>
                    <div class="col-4 form-text">Enter the value</div>
                    <div class="col-4 form-text">Enter the unit (ms/s/m/h/d)</div>
                </div>
                <div class="row mt-1">
                    <div class="col-8"></div>
                    <div class="col-4">
                        <button type="submit" class="btn btn-primary float-end" onclick="delayed_reload()">Add</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <table id="step_tbl" class="table table-striped mt-4">
        <thead>
            <tr>
                <td>Step ID</td>
                <td>Duration (d:h:m:s:ms)</td>
                <td>Sensor targets</td>
                <td>Actions</td>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>
<script>
    document.getElementById('new-step').setAttribute('action','/api/program/step/'+current_prog_id)
    document.getElementById('title-heading').innerHTML = '<h2> Edit Program - ' + current_prog_id + '</h2>'
</script>
{% endblock %}